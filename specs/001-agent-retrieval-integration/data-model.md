# Data Model: RAG Agent Retrieval Integration

**Feature**: RAG Agent Retrieval Integration
**Date**: 2026-01-23
**Branch**: 001-agent-retrieval-integration

## Overview

Data model for the RAG agent system with integrated retrieval, defining the structure of agent queries, retrieval requests, responses, and logging entities.

## Core Entities

### AgentQuery
Represents a query submitted to the agent

- **query_text** (str): The natural language query text from the user
- **user_context** (str, optional): Additional text context provided by the user
- **thread_id** (str, optional): ID of the conversation thread
- **timestamp** (datetime): When the query was submitted

### EmbeddingRequest
Represents a request to generate embeddings for a query

- **query_text** (str): Query text to be embedded
- **input_type** (str, optional): Type of input for embedding model (default: "search_query")

### EmbeddingResponse
Represents the response with generated embeddings

- **embedding_vector** (list[float]): The generated embedding vector
- **model_used** (str): Name of the embedding model used
- **execution_time** (float): Time taken to generate embeddings

### RetrievalRequest
Represents a request to the retrieval system from the agent

- **query_embedding** (list[float]): Embedded query vector to search for
- **top_k** (int, optional): Number of results to retrieve (default: 5)
- **threshold** (float, optional): Minimum similarity threshold (default: 0.0)
- **filters** (dict, optional): Additional filters for the search

### RetrievalResponse
Represents the response from the retrieval system

- **retrieved_chunks** (list[RetrievedChunk]): List of relevant content chunks
- **execution_time** (float): Time taken to execute the retrieval in seconds
- **retrieval_stats** (dict): Statistics about the retrieval
  - **total_candidates** (int): Total number of candidates considered
  - **search_threshold** (float): Threshold used for filtering results
  - **collection_name** (str): Name of the collection searched

### RetrievedChunk
Represents a single chunk of content retrieved from the knowledge base

- **content** (str): The text content of the retrieved chunk
- **score** (float): Similarity score between query and result
- **metadata** (dict): Additional metadata about the source
  - **url** (str): Source URL of the content
  - **title** (str): Title of the source document
  - **section** (str): Section where the content appears
  - **chunk_index** (int): Index of the chunk in the original document

### RankedResults
Represents the retrieval results after ranking

- **ranked_chunks** (list[RetrievedChunk]): List of retrieved chunks ordered by relevance
- **ranking_algorithm** (str): Algorithm used for ranking
- **execution_time** (float): Time taken for ranking process

### AgentResponse
Represents the final response generated by the agent

- **response_text** (str): The agent's response to the user
- **sources_cited** (list[str]): List of sources referenced in the response
- **grounding_confidence** (float): Confidence level in the grounding (0.0-1.0)
- **execution_time** (float): Total time from query to response
- **retrieval_used** (bool): Whether retrieval was used in generating this response

### AgentLogEntry
Represents a log entry for agent activity

- **timestamp** (datetime): When the event occurred
- **event_type** (str): Type of event (query_received, embedding_generated, retrieval_performed, response_sent, error)
- **thread_id** (str): ID of the conversation thread
- **query_text** (str, optional): The original query
- **response_summary** (str, optional): Brief summary of the response
- **error_details** (str, optional): Details if an error occurred
- **execution_time** (float, optional): Time taken for the operation

## Relationships

```
AgentQuery --(triggers)--> EmbeddingRequest
EmbeddingRequest --(processed by)--> EmbeddingService
EmbeddingService --(returns)--> EmbeddingResponse
EmbeddingResponse --(used for)--> RetrievalRequest
RetrievalRequest --(processed by)--> RetrievalSystem
RetrievalSystem --(returns)--> RetrievalResponse
RetrievalResponse --(contains)--> RetrievedChunk[0..*]
RetrievedChunk[0..*] --(used for)--> RankedResults
RankedResults --(used to generate)--> AgentResponse
AgentResponse --(logged as)--> AgentLogEntry[0..*]
```

## Validation Rules

### AgentQuery Validation
- query_text must not be empty
- user_context length should not exceed 10,000 characters

### EmbeddingRequest Validation
- query_text must not be empty
- input_type must be one of allowed values

### RetrievalRequest Validation
- query_embedding must not be empty
- top_k must be between 1 and 20
- threshold must be between 0.0 and 1.0

### RetrievedChunk Validation
- content must not be empty
- score must be between 0.0 and 1.0
- metadata must contain required fields: url, title, section

### AgentResponse Validation
- response_text must not be empty
- sources_cited must reference actual retrieved content
- grounding_confidence must be between 0.0 and 1.0

## State Transitions

### Agent Interaction Process
1. **QUERY_RECEIVED**: AgentQuery is validated and received
2. **EMBEDDING_GENERATED**: Query embedding is created using Cohere
3. **RETRIEVAL_PERFORMED**: Vector similarity search is executed in Qdrant
4. **RESULTS_RANKED**: Retrieved results are ranked by relevance
5. **RESPONSE_GENERATED**: AgentResponse is created based on retrieved context
6. **RESPONSE_SENT**: Response is sent back to the user

### Retrieval Process
1. **QUERY_EMBEDDED**: Query is converted to embedding vector
2. **VECTOR_SEARCH**: Similarity search is performed in Qdrant
3. **RESULTS_FILTERED**: Results are filtered by threshold and relevance
4. **RESULTS_RANKED**: Results are ranked by relevance and quality
5. **CONTEXT_PREPARED**: Context is prepared for agent consumption

## Constraints

- All string fields have maximum length of 50,000 characters unless otherwise specified
- Numeric values must be within appropriate ranges as defined in validation rules
- Timestamps are in ISO 8601 format
- All responses must cite their sources from the retrieved context
- Agent responses must not include information not present in retrieved context or user-provided context
- Embedding vectors must have consistent dimensions based on the model used